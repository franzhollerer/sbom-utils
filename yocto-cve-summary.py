#!/usr/bin/python3
"""Creates a summary of CVEs reported during the Yocto build."""

import sys
import os.path
import argparse
import json
import csv


def is_file(parser, arg):
    if not os.path.exists(arg):
        parser.error(f'The file {arg} does not exist!')
    else:
        return arg


def parse_arguments():
    parser = argparse.ArgumentParser(
        description='Creates a summary of CVEs reported by Yocto')
    parser.add_argument('files',
                        metavar='cve.json',
                        type=lambda x: is_file(parser, x),
                        nargs='+',
                        help='Yocto CVE json file(s)')
    parser.add_argument('-o', '--output-file',
                        help='output file with collected CVEs')
    parser.add_argument('-f', '--output-format',
                        choices=['csv', 'json'],
                        default='csv',
                        help='format of the output file')

    return parser.parse_args()


def collect_cves(files):
    cves = []
    for fn in files:
        with open(fn) as f:
            d = json.load(f)
        package = d['package']
        try:
            assert len(package) == 1
        except AssertionError:
            print(f'AssertionError occurred while processing {fn}',
                  file=sys.stderr)
            raise

        name = package[0]['name']
        version = package[0]['version']

        for issue in package[0]['issue']:
            cve = {}
            cve['name'] = name
            cve['version'] = version
            cve['id'] = issue['id']
            cve['status'] = issue['status']
            if 'description' in issue:
                cve['description'] = issue['description']
            cves.append(cve)

    return cves


def export_cves_as_csv(file, cves):
    fieldnames=['name', 'version', 'id', 'status', 'description']
    writer = csv.DictWriter(file, fieldnames=fieldnames)
    writer.writeheader()
    writer.writerows(cves)


def main():
    args = parse_arguments()
    cves = collect_cves(args.files)
    out = sys.stdout if not args.output_file else open(args.output_file, 'w')
    if args.output_format == 'csv':
        export_cves_as_csv(out, cves)
    else:
        json.dump(cves, out)


if __name__ == "__main__":
    main()

